{"version":3,"file":"Transition.js","sources":["../src/animation/Transition.tsx"],"sourcesContent":["import {\n  defineComponent,\n  ref,\n  h,\n  onActivated,\n  Fragment,\n  onMounted,\n  isVNode,\n  watch,\n  reactive,\n  VNode,\n  useSlots,\n  onBeforeUnmount, watchEffect, computed, getCurrentInstance, ComponentObjectPropsOptions, PropType\n} from 'vue'\nimport Animation, {AnimationProps} from './Animation';\n\nimport noop from './utils/noop';\n\nexport interface TransitionState {\n  state: string | boolean;\n  lastChildren: VNode | ((TransitionProps: any) => VNode | any) | VNode[];\n  currentChildren: VNode | ((TransitionProps: any) => VNode | any) | VNode[];\n}\n\nexport interface TransitionProps extends AnimationProps {\n  children?: VNode | ((TransitionProps: any) => any) | VNode[];\n  from?: Record<string, any>;\n  enter?: Record<string, any>;\n  leave?: Record<string, any>;\n  state?: string | boolean;\n  willEnter?: (value: any) => void;\n  didEnter?: (value: any) => void;\n  willLeave?: (value: any) => void;\n  didLeave?: (value: any) => void;\n  onRest?: (value: any) => void;\n  onStart?: (value: any) => void;\n}\n\nexport const vuePropsType:ComponentObjectPropsOptions<TransitionProps> = {\n  children: [Object, Function] as PropType<TransitionProps['children']>,\n  from: Object,\n  enter: Object,\n  leave: Object,\n  state: {\n    type: [String, Boolean],\n// @ts-ignore\n    default: undefined\n  },\n\n  willEnter: {\n    type: Function as PropType<TransitionProps['willEnter']>,\n    default: noop,\n  },\n  didEnter: {\n    type: Function as PropType<TransitionProps['didEnter']>,\n    default: noop,\n  },\n  willLeave: {\n    type: Function as PropType<TransitionProps['willLeave']>,\n    default: noop,\n  },\n  didLeave: {\n    type: Function as PropType<TransitionProps['didLeave']>,\n    default: noop,\n  },\n  onRest: {\n    type: Function as PropType<TransitionProps['onRest']>,\n    default: noop,\n  },\n  onStart: {\n    type: Function as PropType<TransitionProps['onStart']>,\n    default: noop,\n  },\n}\nconst Transition = defineComponent<TransitionProps>((props, {}) => {\n  const slots = useSlots()\n  // 在keep-alive = true时  相当于 onShow\n  onActivated(() => {\n\n  })\n\n  let instance: any;\n  const state = reactive<TransitionState>({\n    state: '',\n    lastChildren: null,\n    currentChildren: null,\n  })\n\n  function getDerivedStateFromProps(props: TransitionProps, state: TransitionState) {\n    const willUpdateStates: Partial<TransitionState> = {};\n    const children = props.children || slots.default\n    if (\n      children !== state.currentChildren\n      // && (props.children == null || state.currentChildren == null)\n    ) {\n      willUpdateStates.lastChildren = state.currentChildren;\n      willUpdateStates.currentChildren = children;\n\n      if (children == null) {\n        willUpdateStates.state = 'leave';\n      } else {\n        willUpdateStates.state = 'enter';\n      }\n    }\n\n    if (props.state != null) {\n      willUpdateStates.state = props.state;\n    }\n\n    return willUpdateStates;\n  }\n\n  // const defaultSlot = computed(()=>{\n  //   return slots.default\n  // })\n  // const internalInstance = getCurrentInstance();\n  function updateState() {\n    const newState = getDerivedStateFromProps({...props}, {...state})\n    Object.keys(newState).forEach((key) => {\n      // @ts-ignore\n      state[key] = newState[key]\n    })\n  }\n  watch(()=>props.children, () => {\n    updateState()\n  }, {immediate: true})\n  watch(() => props.state, () => {\n    updateState()\n  }, {immediate: true})\n\n  onBeforeUnmount(() => {\n    if (instance) {\n      instance.destroy();\n      instance = null;\n    }\n  })\n\n\n  const _isControlled = () => [true, false, 'enter', 'leave'].includes(props.state);\n\n  const forwardInstance = (instance0: any) => {\n    instance = instance0;\n  };\n\n  const onRest = (funcProps: any) => {\n    if (state.state === 'enter') {\n      props.didEnter(funcProps);\n    } else if (state.state === 'leave') {\n      state.currentChildren = null\n      state.lastChildren = null\n      props.didLeave(funcProps);\n    }\n    props.onRest(funcProps);\n  };\n\n  const onStart = (funcProps: any) => {\n\n    if (state.state === 'enter') {\n      props.willEnter(funcProps);\n    } else if (state.state === 'leave') {\n      props.willLeave(funcProps);\n    }\n\n    props.onStart(funcProps);\n  };\n\n\n  return () => {\n\n    const {from: propsFrom, enter, leave, children:noNeed, ...restProps} = props;\n\n    let from = {};\n    let to = {};\n\n    const isControlled = _isControlled();\n    let children: any;\n\n    if (isControlled) {\n      children = props.children || slots.default;\n      state.state = props.state;\n    } else if (state.currentChildren == null && state.lastChildren == null) {\n      console.log('transition: no children')\n      return null;\n    }\n\n    if (state.state === 'enter') {\n      from = propsFrom;\n      to = enter;\n\n      if (!isControlled) {\n        children = state.currentChildren;\n      }\n    } else if (state.state === 'leave') {\n      from = enter;\n      to = leave;\n\n      if (!isControlled) {\n        children = state.lastChildren;\n      }\n    }\n    // TODO vue 这里的相同的 props 传给子组件 不会覆盖 而是会合并成数组。\n    //  so ...\n    const finalProps = {...restProps, onRest, onStart, from, to}\n\n    // console.log(finalProps,123)\n\n\n    return (\n      <Animation {...finalProps} force>\n        {\n          (propsRender: Record<string, any>) => {\n            // console.log(propsRender)\n            return (\n              typeof children === 'function' ? children(propsRender) : isVNode(children) ? children : null\n            )\n          }\n        }\n      </Animation>\n    )\n  }\n}, {\n  props: vuePropsType,\n  name: 'Transition'\n})\n\n\nexport default Transition\n\n"],"names":["vuePropsType","children","Object","Function","from","enter","leave","state","type","String","Boolean","default","undefined","willEnter","noop","didEnter","willLeave","didLeave","onRest","onStart","Transition","defineComponent","props","slots","useSlots","onActivated","reactive","lastChildren","currentChildren","getDerivedStateFromProps","willUpdateStates","updateState","newState","keys","forEach","key","watch","immediate","onBeforeUnmount","_isControlled","includes","funcProps","propsFrom","noNeed","restProps","to","isControlled","console","log","finalProps","_createVNode","Animation","_mergeProps","propsRender","isVNode","name"],"mappings":"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"}