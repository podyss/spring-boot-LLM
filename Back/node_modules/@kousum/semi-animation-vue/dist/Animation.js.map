{"version":3,"file":"Animation.js","sources":["../src/animation/Animation.tsx"],"sourcesContent":["import {\n  defineComponent,\n  ref,\n  h,\n  onActivated,\n  Fragment,\n  isVNode,\n  onMounted,\n  onUnmounted,\n  watch,\n  onBeforeMount, reactive, onBeforeUnmount, shallowRef, CSSProperties, ComponentObjectPropsOptions, PropType\n} from 'vue'\n\nimport {Animation as SemiAnimation, events} from '@douyinfe/semi-animation';\nimport noop from './utils/noop';\n\n\nexport interface AnimationProps {\n  onStart?: Function;\n  onFrame?: Function;\n  onPause?: Function;\n  onResume?: Function;\n  onStop?: Function;\n  onRest?: Function;\n  from?: Record<string, any>;\n  to?: Record<string, any>;\n  reverse?: boolean;\n  reset?: boolean;\n  force?: boolean;\n  config?: Record<string, any>;\n  autoStart?: boolean;\n  forwardInstance?: (value: any) => void;\n  immediate?: boolean;\n\n  enter?:any\n  leave?:any\n  state?:any\n  willEnter?:any\n  didEnter?:any\n  willLeave?:any\n  didLeave?:any\n}\n\nexport const vuePropsType:ComponentObjectPropsOptions<AnimationProps> = {\n  onStart: {\n    type: Function,\n    default: noop,\n  },\n  onFrame: {\n    type: Function,\n    default: noop,\n  },\n  onPause: {\n    type: Function,\n    default: noop,\n  },\n  onResume: {\n    type: Function,\n    default: noop,\n  },\n  onStop: {\n    type: Function,\n    default: noop,\n  },\n  onRest: {\n    type: Function,\n    default: noop,\n  },\n\n  from: Object,\n  to: Object,\n  reverse: Boolean,\n  reset: Boolean,\n  force: {\n    type:Boolean,\n    default: false,\n  },\n  config: Object,\n  autoStart: {\n    type: Boolean,\n    default: true\n  },\n  forwardInstance: Function as PropType<AnimationProps['forwardInstance']>,\n  immediate: Boolean,\n\n\n\n  enter: Object as PropType<AnimationProps['enter']>,\n  leave: Object as PropType<AnimationProps['leave']>,\n  state: [String, Boolean] as PropType<AnimationProps['state']>,\n\n  willEnter: {\n    type: Function as PropType<AnimationProps['willEnter']>,\n    default: noop,\n  },\n  didEnter: {\n    type: Function as PropType<AnimationProps['didEnter']>,\n    default: noop,\n  },\n  willLeave: {\n    type: Function as PropType<AnimationProps['willLeave']>,\n    default: noop,\n  },\n  didLeave: {\n    type: Function as PropType<AnimationProps['willLeave']>,\n    default: noop,\n  },\n}\n\nconst Index = defineComponent<AnimationProps>((props, {slots}) => {\n  // 在keep-alive = true时  相当于 onShow\n\n  let _mounted: boolean = false;\n  let _destroyed: boolean = false;\n  const animation = shallowRef<SemiAnimation>(null);\n  let reverse: () => void;\n  let destroy: () => void;\n  let reset: () => void;\n  let resume: () => void;\n  let end: () => void;\n  let stop: () => void;\n  let pause: () => void;\n  let start: () => void;\n\n  const state = reactive<{currentStyle:Record<string, any>}>({\n    currentStyle: {},\n  })\n\n  let startOrNot: any = function () {\n    throw new Error('Method not implemented.');\n  }\n\n  initAnimation();\n  bindEvents();\n\n  onMounted(() => {\n    _mounted = true;\n    const {forwardInstance} = props;\n\n    if (animation.value === null) {\n      // didmount/willUnmount may be called twice when React.StrictMode is true in React 18, we need to ensure that this.animation is correct\n      initAnimation();\n      bindEvents();\n    }\n\n\n    if (typeof forwardInstance === 'function') {\n      // console.error(forwardInstance)\n      forwardInstance(animation.value);\n    }\n\n    startOrNot();\n  })\n\n  onBeforeUnmount(() => {\n    _mounted = false;\n    if (animation.value) {\n      animation.value.destroy();\n      animation.value = null;\n    }\n  })\n\n  watch([() => props.from, () => props.to, ()=>props.reset, ()=>props.force], (n, [prevPropsFrom, prevPropsTo]) => {\n\n    if (props.reset) {\n      if (props.from !== prevPropsFrom || props.to !== prevPropsTo) {\n        destroy();\n        initAnimation();\n        startOrNot();\n      }\n    }\n\n\n    if (props.force) {\n      if (props.to !== prevPropsTo) {\n        initAnimation({\n          ...props,\n          from: prevPropsTo,\n        });\n        startOrNot();\n      }\n    }\n\n  })\n\n  function initAnimation (props0?: AnimationProps) {\n    // eslint-disable-next-line eqeqeq\n    props0 = props0 == null ? props : props0;\n    // eslint-disable-next-line prefer-const\n    let {from, to, config, reverse} = props0;\n\n    if (reverse) {\n      [from, to] = [to, from];\n    }\n\n    animation.value = new SemiAnimation(\n      {\n        from: {...from},\n        to: {...to},\n      },\n      {\n        ...config,\n      }\n    )\n\n    events.forEach((event: string) => {\n      const propName = `on${event[0].toUpperCase() + event.slice(1)}`;\n      // eslint-disable-next-line @typescript-eslint/no-shadow\n      animation.value.on(event, (propsAnimation: any) => {\n        // avoid memory leak\n        //console.log(_mounted,_destroyed)\n        if (_mounted && !_destroyed) {\n          state.currentStyle = {...propsAnimation}\n          // @ts-ignore\n          props[propName](propsAnimation);\n        }\n      });\n    });\n\n    _destroyed = false;\n  };\n  function bindEvents() {\n    startOrNot = () => {\n      const {immediate, autoStart} = props;\n      if (immediate) {\n        end();\n      } else if (autoStart) {\n        start();\n      }\n    };\n    start = () => {\n      animation.value && animation.value.start();\n    };\n    pause = () => {\n      animation.value && animation.value.pause();\n    };\n    stop = () => {\n      animation.value && animation.value.stop();\n    };\n    end = () => {\n      animation.value && animation.value.end();\n    };\n    resume = () => {\n      animation.value && animation.value.resume();\n    };\n    reset = () => {\n      if (animation.value) {\n        animation.value.reset();\n        startOrNot();\n      }\n    };\n    reverse = () => {\n      if (animation.value) {\n        animation.value.reverse();\n        startOrNot();\n      }\n    };\n    destroy = () => {\n      _destroyed = true;\n      animation.value && animation.value.destroy();\n    };\n  };\n\n\n  return () => {\n    const children = slots.default;\n    const styles:any = {}\n    Object.keys(state.currentStyle).forEach(key=>{\n      if (['height',  'width', 'left', 'right', 'top', 'bottom', 'maxHeight', 'minHeight', 'maxWidth', 'minWidth'].includes(key)){\n        if (typeof state.currentStyle[key] === 'number'){\n          styles[key] = state.currentStyle[key] + 'px'\n        }\n      }else{\n        styles[key] = state.currentStyle[key]\n      }\n    })\n    if (typeof children === 'function' && animation.value) {\n      return children(styles);\n    } else if (isVNode(children)) {\n      return children;\n    } else {\n      return null;\n    }\n  }\n}, {\n  props: vuePropsType,\n  name: 'Animation'\n})\n\n\nexport default Index\n\n"],"names":["vuePropsType","onStart","type","Function","default","noop","onFrame","onPause","onResume","onStop","onRest","from","Object","to","reverse","Boolean","reset","force","config","autoStart","forwardInstance","immediate","enter","leave","state","String","willEnter","didEnter","willLeave","didLeave","Index","defineComponent","props","slots","_mounted","_destroyed","animation","shallowRef","destroy","end","start","reactive","currentStyle","startOrNot","Error","initAnimation","bindEvents","onMounted","value","onBeforeUnmount","watch","n","prevPropsFrom","prevPropsTo","props0","SemiAnimation","events","forEach","event","propName","toUpperCase","slice","on","propsAnimation","children","styles","keys","key","includes","isVNode","name"],"mappings":"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"}