{"version":3,"file":"previewImage.js","sources":["../../src/components/image/previewImage.tsx"],"sourcesContent":["import { cssClasses } from '@douyinfe/semi-foundation/image/constants';\nimport { FooterProps, PreviewImageProps, PreviewImageStates, PreviewProps } from './interface';\nimport * as PropTypes from '../PropTypes';\nimport Spin from '../spin';\nimport PreviewImageFoundation, { PreviewImageAdapter } from '@douyinfe/semi-foundation/image/previewImageFoundation';\nimport {\n  ComponentObjectPropsOptions,\n  CSSProperties,\n  defineComponent,\n  h,\n  onMounted,\n  onUnmounted,\n  PropType,\n  reactive,\n  ref,\n  useSlots,\n  watch,\n} from 'vue';\nimport { vuePropsMake } from '../PropTypes';\nimport { useBaseComponent } from '../_base/baseComponent';\nimport { CombineProps } from '../interface';\n\nconst prefixCls = cssClasses.PREFIX;\nconst preViewImgPrefixCls = `${prefixCls}-preview-image`;\n\nconst propTypes: CombineProps<PreviewImageProps> = {\n  src: PropTypes.string,\n  rotation: PropTypes.number,\n  style: PropTypes.object,\n  // maxZoom: PropTypes.number,\n  // minZoom: PropTypes.number,\n  // zoomStep: PropTypes.number,\n  zoom: PropTypes.number,\n  ratio: PropTypes.string as PropType<PreviewImageProps['ratio']>,\n  disableDownload: PropTypes.bool as PropType<PreviewImageProps['disableDownload']>,\n  clickZoom: PropTypes.number,\n  setRatio: PropTypes.func as PropType<PreviewImageProps['setRatio']>,\n  onZoom: PropTypes.func as PropType<PreviewImageProps['onZoom']>,\n  onLoad: PropTypes.func as PropType<PreviewImageProps['onLoad']>,\n  onError: PropTypes.func as PropType<PreviewImageProps['onError']>,\n  crossOrigin: PropTypes.string as PropType<PreviewImageProps['crossOrigin']>,\n};\n\nconst defaultProps = {\n  // maxZoom: 5,\n  // minZoom: 0.1,\n  // zoomStep: 0.1,\n  zoom: undefined,\n};\nexport const vuePropsType = vuePropsMake<PreviewImageProps>(propTypes, defaultProps);\nconst PreviewImage = defineComponent({\n  props: { ...vuePropsType },\n  name: 'PreviewImage',\n  setup(props, {expose}) {\n    const slots = useSlots();\n\n    const state = reactive<PreviewImageStates>({\n      width: 0,\n      height: 0,\n      loading: true,\n      translate: {\n        x: 0,\n        y: 0\n      },\n      currZoom: props.zoom\n    });\n    const { adapter: adapterInject } = useBaseComponent<PreviewImageProps>(props, state);\n    function adapter_(): PreviewImageAdapter<PreviewImageProps, PreviewImageStates> {\n      return {\n        ...adapterInject<PreviewImageProps, PreviewImageStates>(),\n        getContainer: () => {\n          return containerRef.value;\n        },\n        getImage: () => {\n          return imageRef.value;\n        },\n        setLoading: (loading: boolean) => {\n          state.loading = loading;\n        },\n        setImageCursor: (canDrag: boolean) => {\n          imageRef.value.style.cursor = canDrag ? 'grab' : 'default';\n        },\n      };\n    }\n    const adapter = adapter_();\n    const containerRef = ref();\n    const imageRef = ref<HTMLImageElement>();\n    const foundation = new PreviewImageFoundation(adapter);\n\n    expose({\n      foundation\n    })\n    onMounted(() => {\n      foundation.init();\n      window.addEventListener('resize', onWindowResize);\n    });\n\n    onUnmounted(() => {\n      window.removeEventListener('resize', onWindowResize);\n    });\n\n    const onWindowResize = (): void => {\n      foundation.handleWindowResize();\n    };\n\n    // Determine the response method of right click according to the disableDownload parameter in props\n    const handleRightClickImage = (e) => {\n      foundation.handleRightClickImage(e);\n    };\n\n    const handleLoad = (e): void => {\n      foundation.handleLoad(e);\n    };\n\n    const handleError = (e): void => {\n      foundation.handleError(e);\n    };\n\n    const handleImageMove = (e): void => {\n      foundation.handleImageMove(e);\n    };\n\n    const handleMouseDown = (e: any): void => {\n      foundation.handleImageMouseDown(e);\n    };\n\n    // If src changes, start a new loading\n    // If the incoming zoom changes, other content changes are determined based on the new zoom value\n    // When the incoming ratio is changed, if it\"s adaptation, then resizeImage is triggered to make the image adapt to the page\n    // else if it\"s adaptation is realSize, then onZoom(1) is called to make the image size the original size;\n    // When the incoming rotation angle of the image changes, it needs to be resized to make the image fit on the page\n    watch(\n      [\n        () => props.src,\n        () => props.zoom,\n        () => props.ratio,\n        () => props.rotation,\n        () => state.currZoom,\n        () => containerRef.value,\n      ],\n      (value, [prevPropsSrc, prevPropsZoom, prevPropsRatio, prevPropsRotation, prevStatesCurrZoom], onCleanup) => {\n        const zoomChange = 'zoom' in props && props.zoom !== state.currZoom;\n        const srcChange = props.src && props.src !== prevPropsSrc;\n        if (srcChange) {\n          foundation.setLoading(true);\n        }\n        // If the incoming zoom changes, other content changes are determined based on the new zoom value\n        // if (zoomChange) {\n        //   foundation.calculatePreviewImage(props.zoom, null);\n        // }\n        if (!zoomChange && !srcChange) {\n          if ('ratio' in props && props.ratio !== prevPropsRatio) {\n            foundation.handleRatioChange();\n          }\n          if ('rotation' in props && props.rotation !== prevPropsRotation) {\n            onWindowResize();\n          }\n        }\n      }\n    );\n\n    return () => {\n      const { src, rotation, crossOrigin } = props;\n      const { loading, width, height, translate } = state;\n      const imgStyle: CSSProperties = {\n        position: \"absolute\",\n        visibility: loading ? \"hidden\" : \"visible\",\n        transform: `translate(${translate.x}px, ${translate.y}px) rotate(${rotation}deg)`,\n        width: `${width}px`,\n        height: `${height}px`,\n      };\n      return (\n        <div class={`${preViewImgPrefixCls}`} ref={containerRef}>\n          {/* eslint-disable-next-line jsx-a11y/no-noninteractive-element-interactions */}\n          <img\n            ref={imageRef}\n            src={src}\n            alt=\"previewImag\"\n            class={`${preViewImgPrefixCls}-img`}\n            key={src}\n            onMousemove={handleImageMove}\n            onMousedown={handleMouseDown}\n            onContextmenu={handleRightClickImage}\n            onDragstart={(e): void => e.preventDefault()}\n            onLoad={handleLoad}\n            onError={handleError}\n            style={imgStyle}\n            crossorigin={crossOrigin}\n          />\n          {loading && <Spin size={'large'} wrapperClassName={`${preViewImgPrefixCls}-spin`} />}\n        </div>\n      );\n    };\n  },\n});\n\nexport default PreviewImage;\n"],"names":["prefixCls","cssClasses","PREFIX","preViewImgPrefixCls","propTypes","src","PropTypes","string","rotation","number","style","object","zoom","ratio","disableDownload","bool","clickZoom","setRatio","func","onZoom","onLoad","onError","crossOrigin","defaultProps","undefined","vuePropsType","vuePropsMake","PreviewImage","defineComponent","props","name","setup","expose","useSlots","state","reactive","width","height","loading","translate","x","y","currZoom","adapter","adapterInject","useBaseComponent","adapter_","getContainer","containerRef","value","getImage","imageRef","setLoading","setImageCursor","canDrag","cursor","ref","foundation","PreviewImageFoundation","onMounted","init","window","addEventListener","onWindowResize","onUnmounted","removeEventListener","handleWindowResize","handleRightClickImage","e","handleLoad","handleError","handleImageMove","handleMouseDown","handleImageMouseDown","watch","prevPropsSrc","prevPropsZoom","prevPropsRatio","prevPropsRotation","prevStatesCurrZoom","onCleanup","zoomChange","srcChange","handleRatioChange","imgStyle","position","visibility","transform","_createVNode","preventDefault","Spin"],"mappings":"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"}