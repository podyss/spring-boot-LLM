{"version":3,"file":"baseComponent.js","sources":["../../src/components/_base/baseComponent.tsx"],"sourcesContent":["import {\n  defineComponent,\n  ref,\n  shallowRef,\n  h,\n  CSSProperties,\n  Ref,\n  getCurrentInstance,\n  useAttrs,\n  toRaw,\n  ShallowRef,\n} from 'vue';\nimport baseLog from '@douyinfe/semi-foundation/utils/log';\nimport { DefaultAdapter } from '@douyinfe/semi-foundation/base/foundation';\nimport { VALIDATE_STATUS } from '@douyinfe/semi-foundation/base/constants';\nimport getDataAttr_ from '@douyinfe/semi-foundation/utils/getDataAttr';\nimport { ArrayElement } from './base';\nimport type { ContextValue } from '../configProvider/context';\nimport { useConfigContext } from '../configProvider/context/Consumer';\n\nconst { hasOwnProperty } = Object.prototype;\n\nexport type ValidateStatus = ArrayElement<typeof VALIDATE_STATUS>;\n\nexport type BaseProps = {\n  style?: CSSProperties;\n  className?: string;\n\n  // [key: string]: any,\n};\n\nexport function getProps(props: Record<string, any>) {\n  let newProps: any = {};\n  for (let i in props) {\n    if (props[i] !== undefined) {\n      newProps[i] = props[i];\n    }\n  }\n  // console.log('value' in newProps)\n  return newProps;\n}\nexport const useBaseComponent: <U extends BaseProps = {}, S = Record<string, any>>(\n  props: U,\n  state: S\n) => {\n  isControlled: (key: any) => boolean;\n  cache: any;\n  adapter: <P extends BaseProps, S = {}>() => DefaultAdapter<P, S>;\n  log: (text: string, ...rest: any) => any;\n  context: Ref<ContextValue>;\n  foundation: ShallowRef<any>;\n  state: any;\n  getDataAttr: () => Record<string, any>;\n  setStateAsync: (state: Partial<S>)=>Promise<void>;\n} = (props, state) => {\n  const attrs = useAttrs();\n  const cache = shallowRef<any>({});\n  const foundation = shallowRef<any>(null);\n  const {getProps: getPropsUseHasInProps} = useHasInProps()\n\n  const isControlled = (key: any) => {\n    return Boolean(key && props && typeof props === 'object' && hasOwnProperty.call(adapter().getProps(), key));\n  };\n\n  const { context } = useConfigContext();\n  const currentInstance = getCurrentInstance();\n  function adapter<P extends BaseProps = {}, S = {}>(): DefaultAdapter<P, S> {\n    return {\n      getContext: (key) => {\n        // eslint-disable-line\n        // @ts-ignore\n        const contexts: Record<string, Ref> = currentInstance.provides;\n        let context_ = { ...context.value };\n        Object.keys(contexts).forEach((key) => {\n          context_ = { ...context_, ...contexts[key].value };\n        });\n\n        if (context_ && key) {\n          // @ts-ignore\n          return context_[key];\n        }\n      },\n      getContexts: () => {\n        // @ts-ignore\n        const contexts: Record<string, Ref> = currentInstance.provides;\n        let context_ = { ...context.value };\n        Object.keys(contexts).forEach((key) => {\n          context_ = { ...context_, ...contexts[key].value };\n        });\n\n        return context_;\n      }, // eslint-disable-line\n      getProp: (key) => {\n        return props[key];\n      }, // eslint-disable-line\n      // return all props\n      // @ts-ignore\n      getProps: () => {\n        return getPropsUseHasInProps(props)\n      }, // eslint-disable-line\n      getState: (key) => {\n        if (state[key] instanceof Object) {\n          return toRaw(state[key])\n        }\n        return state[key];\n      }, // eslint-disable-line\n      // TODO toRaw会失去响应\n      getStates: () => {\n        const newState = {};\n        Object.keys(state).map(key=>{\n          if (state[key] instanceof Object) {\n            newState[key] = toRaw(state[key])\n          }\n        })\n        return {\n          ...state,\n          ...newState\n        } as any\n      }, // eslint-disable-line\n      setState: (states, cb) => {\n        // console.log('setState', states)\n        for (let i in states) {\n          if (states.hasOwnProperty(i)) {\n            //@ts-ignore\n            state[i] = states[i];\n          }\n        }\n        // this.setState({ ...states }, cb)\n      }, // eslint-disable-line\n      getCache: (key) => key && cache.value[key], // eslint-disable-line\n      getCaches: () => cache.value, // eslint-disable-line\n      setCache: (key, value) => key && (cache.value[key] = value), // eslint-disable-line\n      stopPropagation: (e) => {\n        // eslint-disable-line\n        try {\n          e.stopPropagation();\n          e && e.stopImmediatePropagation && e.stopImmediatePropagation();\n        } catch (error) {}\n      },\n      persistEvent: (e: KeyboardEvent | MouseEvent) => {\n        // e && e.persist && typeof e.persist === 'function' ? e.persist() : null;\n      },\n    };\n  }\n\n  function log(text: string, ...rest: any): any {\n    return baseLog(text, ...rest);\n  }\n  function getDataAttr() {\n    return getDataAttr_({ ...props, ...attrs });\n  }\n  function setStateAsync(state_: Partial<any>){\n    return new Promise<void>(resolve=>{\n      Object.keys(state_).forEach(key=>{\n        state[key] = state_[key]\n      })\n      resolve()\n    });\n  }\n  return {\n    cache,\n    foundation,\n    state,\n    isControlled,\n    context,\n    adapter,\n    log,\n    getDataAttr,\n    setStateAsync,\n  };\n};\n\nexport function useHasInProps() {\n  const instance = getCurrentInstance();\n\n  function hasInProps(key: string): boolean | undefined {\n    if (instance) {\n      // 检查vnode的props是否包含value键\n      return instance.vnode.props && key in instance.vnode.props;\n    }\n  }\n\n  function getProps_<P>(props: P): P {\n    if (!instance.vnode.props) {\n      return getProps(props);\n    }\n    const tProps: any = {};\n    for (const tPropsKey in props) {\n      if (props.hasOwnProperty(tPropsKey) && tPropsKey in instance.vnode.props) {\n        tProps[tPropsKey] = props[tPropsKey];\n      }\n\n      if (props.hasOwnProperty(tPropsKey) && props[tPropsKey] !== undefined && props[tPropsKey] !== false) {\n        tProps[tPropsKey] = props[tPropsKey];\n      }\n      //@ts-ignore\n      const defaultProps = instance.propsOptions[0]\n      if(tProps[tPropsKey] === undefined && defaultProps[tPropsKey].default !== undefined) {\n        tProps[tPropsKey] = defaultProps[tPropsKey].default;\n      }\n    }\n    return tProps;\n  }\n\n  return {\n    hasInProps,\n    getProps: getProps_,\n  };\n}\n"],"names":["hasOwnProperty","Object","prototype","getProps","props","newProps","i","undefined","useBaseComponent","state","attrs","useAttrs","cache","shallowRef","foundation","getPropsUseHasInProps","useHasInProps","isControlled","key","Boolean","call","adapter","context","useConfigContext","currentInstance","getCurrentInstance","getContext","contexts","provides","context_","value","keys","forEach","getContexts","getProp","getState","toRaw","getStates","newState","map","setState","states","cb","getCache","getCaches","setCache","stopPropagation","e","stopImmediatePropagation","persistEvent","log","text","rest","baseLog","getDataAttr","getDataAttr_","setStateAsync","state_","Promise","resolve","instance","hasInProps","vnode","getProps_","tProps","tPropsKey","defaultProps","propsOptions","default"],"mappings":";;;;AAoBA,MAAM;AAAA,EAAEA,gBAAAA;AAAe,IAAIC,OAAOC;AAW3B,SAASC,EAASC,GAA4B;AACnD,MAAIC,IAAgB,CAAA;AACpB,WAASC,KAAKF;AACZ,IAAIA,EAAME,CAAC,MAAMC,WACfF,EAASC,CAAC,IAAIF,EAAME,CAAC;AAIzB,SAAOD;AACT;MACaG,IAaTA,CAACJ,GAAOK,MAAU;AACpB,QAAMC,IAAQC,KACRC,IAAQC,EAAgB,CAAA,CAAE,GAC1BC,IAAaD,EAAgB,IAAI,GACjC;AAAA,IAACV,UAAUY;AAAAA,EAAsB,IAAGC,EAAa,GAEjDC,IAAgBC,CAAAA,MACbC,GAAQD,KAAOd,KAAS,OAAOA,KAAU,YAAYJ,EAAeoB,KAAKC,EAAS,EAAClB,SAAQ,GAAIe,CAAG,IAGrG;AAAA,IAAEI,SAAAA;AAAAA,EAAS,IAAGC,EAAgB,GAC9BC,IAAkBC;AACxB,WAASJ,IAAkE;AACzE,WAAO;AAAA,MACLK,YAAaR,CAAAA,MAAQ;AAGnB,cAAMS,IAAgCH,EAAgBI;AACtD,YAAIC,IAAW;AAAA,UAAE,GAAGP,EAAQQ;AAAAA;AAK5B,YAJA7B,OAAO8B,KAAKJ,CAAQ,EAAEK,QAASd,CAAAA,MAAQ;AACrCW,UAAAA,IAAW;AAAA,YAAE,GAAGA;AAAAA,YAAU,GAAGF,EAAST,CAAG,EAAEY;AAAAA;QAC7C,CAAC,GAEGD,KAAYX;AAEd,iBAAOW,EAASX,CAAG;AAAA,MAEtB;AAAA,MACDe,aAAaA,MAAM;AAEjB,cAAMN,IAAgCH,EAAgBI;AACtD,YAAIC,IAAW;AAAA,UAAE,GAAGP,EAAQQ;AAAAA;AAC5B7B,sBAAO8B,KAAKJ,CAAQ,EAAEK,QAASd,CAAAA,MAAQ;AACrCW,UAAAA,IAAW;AAAA,YAAE,GAAGA;AAAAA,YAAU,GAAGF,EAAST,CAAG,EAAEY;AAAAA;QAC7C,CAAC,GAEMD;AAAAA,MACR;AAAA;AAAA,MACDK,SAAUhB,CAAAA,MACDd,EAAMc,CAAG;AAAA;AAAA;AAAA;AAAA,MAIlBf,UAAUA,MACDY,EAAsBX,CAAK;AAAA;AAAA,MAEpC+B,UAAWjB,CAAAA,MACLT,EAAMS,CAAG,aAAajB,SACjBmC,EAAM3B,EAAMS,CAAG,CAAC,IAElBT,EAAMS,CAAG;AAAA;AAAA;AAAA,MAGlBmB,WAAWA,MAAM;AACf,cAAMC,IAAW,CAAA;AACjBrC,sBAAO8B,KAAKtB,CAAK,EAAE8B,IAAIrB,CAAAA,MAAK;AAC1B,UAAIT,EAAMS,CAAG,aAAajB,WACxBqC,EAASpB,CAAG,IAAIkB,EAAM3B,EAAMS,CAAG,CAAC;AAAA,QAEpC,CAAC,GACM;AAAA,UACL,GAAGT;AAAAA,UACH,GAAG6B;AAAAA;MAEN;AAAA;AAAA,MACDE,UAAUA,CAACC,GAAQC,MAAO;AAExB,iBAASpC,KAAKmC;AACZ,UAAIA,EAAOzC,eAAeM,CAAC,MAEzBG,EAAMH,CAAC,IAAImC,EAAOnC,CAAC;AAAA,MAIxB;AAAA;AAAA,MACDqC,UAAWzB,CAAAA,MAAQA,KAAON,EAAMkB,MAAMZ,CAAG;AAAA;AAAA,MACzC0B,WAAWA,MAAMhC,EAAMkB;AAAAA;AAAAA,MACvBe,UAAUA,CAAC3B,GAAKY,MAAUZ,MAAQN,EAAMkB,MAAMZ,CAAG,IAAIY;AAAAA;AAAAA,MACrDgB,iBAAkBC,CAAAA,MAAM;AAEtB,YAAI;AACFA,UAAAA,EAAED,gBAAe,GACjBC,KAAKA,EAAEC,4BAA4BD,EAAEC,yBAAwB;AAAA,QAC/D,QAAgB;AAAA,QAAC;AAAA,MAClB;AAAA,MACDC,cAAeF,CAAAA,MAAkC;AAAA,MAC/C;AAAA;EAGN;AAEA,WAASG,EAAIC,MAAiBC,GAAgB;AAC5C,WAAOC,EAAQF,GAAM,GAAGC,CAAI;AAAA,EAC9B;AACA,WAASE,IAAc;AACrB,WAAOC,EAAa;AAAA,MAAE,GAAGnD;AAAAA,MAAO,GAAGM;AAAAA,IAAM,CAAC;AAAA,EAC5C;AACA,WAAS8C,EAAcC,GAAqB;AAC1C,WAAO,IAAIC,QAAcC,CAAAA,MAAS;AAChC1D,aAAO8B,KAAK0B,CAAM,EAAEzB,QAAQd,CAAAA,MAAK;AAC/BT,QAAAA,EAAMS,CAAG,IAAIuC,EAAOvC,CAAG;AAAA,MACzB,CAAC,GACDyC;IACF,CAAC;AAAA,EACH;AACA,SAAO;AAAA,IACL/C,OAAAA;AAAAA,IACAE,YAAAA;AAAAA,IACAL,OAAAA;AAAAA,IACAQ,cAAAA;AAAAA,IACAK,SAAAA;AAAAA,IACAD,SAAAA;AAAAA,IACA6B,KAAAA;AAAAA,IACAI,aAAAA;AAAAA,IACAE,eAAAA;AAAAA;AAEJ;AAEO,SAASxC,IAAgB;AAC9B,QAAM4C,IAAWnC;AAEjB,WAASoC,EAAW3C,GAAkC;AACpD,QAAI0C;AAEF,aAAOA,EAASE,MAAM1D,SAASc,KAAO0C,EAASE,MAAM1D;AAAAA,EAEzD;AAEA,WAAS2D,EAAa3D,GAAa;AACjC,QAAI,CAACwD,EAASE,MAAM1D;AAClB,aAAOD,EAASC,CAAK;AAEvB,UAAM4D,IAAc,CAAA;AACpB,eAAWC,KAAa7D,GAAO;AAC7B,MAAIA,EAAMJ,eAAeiE,CAAS,KAAKA,KAAaL,EAASE,MAAM1D,UACjE4D,EAAOC,CAAS,IAAI7D,EAAM6D,CAAS,IAGjC7D,EAAMJ,eAAeiE,CAAS,KAAK7D,EAAM6D,CAAS,MAAM1D,UAAaH,EAAM6D,CAAS,MAAM,OAC5FD,EAAOC,CAAS,IAAI7D,EAAM6D,CAAS;AAGrC,YAAMC,IAAeN,EAASO,aAAa,CAAC;AAC5C,MAAGH,EAAOC,CAAS,MAAM1D,UAAa2D,EAAaD,CAAS,EAAEG,YAAY7D,WACxEyD,EAAOC,CAAS,IAAIC,EAAaD,CAAS,EAAEG;AAAAA,IAEhD;AACA,WAAOJ;AAAAA,EACT;AAEA,SAAO;AAAA,IACLH,YAAAA;AAAAA,IACA1D,UAAU4D;AAAAA;AAEd;"}