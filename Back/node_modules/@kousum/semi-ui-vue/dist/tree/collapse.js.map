{"version":3,"file":"collapse.js","sources":["../../src/components/tree/collapse.tsx"],"sourcesContent":["import { Transition } from '@kousum/semi-animation-vue';\nimport * as PropTypes from '../PropTypes';\nimport { vuePropsMake } from '../PropTypes';\nimport { noop } from 'lodash';\nimport { cssClasses } from '@douyinfe/semi-foundation/collapsible/constants';\nimport getMotionObjFromProps from '@douyinfe/semi-foundation/utils/getMotionObjFromProps';\nimport {\n  ComponentObjectPropsOptions,\n  CSSProperties,\n  defineComponent,\n  h,\n  nextTick,\n  PropType,\n  ref,\n  useSlots,\n  watch,\n} from 'vue';\nimport { CombineProps } from '../interface';\n\nexport interface CollapseProps {\n  motion?: boolean;\n  duration?: number;\n  onMotionEnd?: () => void;\n  motionType?: string;\n}\n\nexport interface TransitionStyle {\n  [x: string]: any;\n  maxHeight?: number;\n}\n\nconst ease = 'cubicBezier(.25,.1,.25,1)';\nconst propsType: CombineProps<CollapseProps> = {\n  motion: PropTypes.oneOfType([PropTypes.bool, PropTypes.func, PropTypes.object]),\n  duration: PropTypes.number,\n  onMotionEnd: PropTypes.func as PropType<CollapseProps['onMotionEnd']>,\n  motionType: String,\n}\nexport const vuePropsType = vuePropsMake<CollapseProps>(\n  propsType,\n  {\n    duration: 250,\n    motion: true,\n    onMotionEnd: noop,\n  }\n);\nconst Collapse = defineComponent({\n  props: { ...vuePropsType },\n  name: 'Collapse',\n  setup(props, {}) {\n    const slots = useSlots();\n\n    const ref_ = ref();\n    const maxHeight = ref(0);\n    function setMaxHeight(val: number) {\n      maxHeight.value = val;\n    }\n    // cache last state\n    const open = ref(true);\n    function setOpen(val: boolean) {\n      open.value = val;\n    }\n    const left = ref(false);\n    function setLeft(val: boolean) {\n      left.value = val;\n    }\n    const immediateAttr = ref(false);\n    function setImmediateAttr(val: boolean) {\n      immediateAttr.value = val;\n    }\n\n    // onMounted(()=>{\n    //     useEffect()\n    // })\n\n    watch(\n      () => props.motionType,\n      () => {\n        useEffect();\n      }\n    );\n\n    function useEffect() {\n      if (props.motionType === 'enter') {\n        !open.value && setOpen(true);\n        left.value && setLeft(false);\n      } else if (props.motionType === 'leave') {\n        !open.value && setOpen(true);\n        !immediateAttr.value && setImmediateAttr(true);\n        left.value && setLeft(false);\n      }\n    }\n\n    let motionType = '';\n    const setHeight = (node: any) => {\n      // TODO 渲染时机不同 watch 在setHeight 之前执行了\n      if (props.motionType !== motionType) {\n        useEffect();\n        motionType = props.motionType;\n      }\n      nextTick(() => {\n        const currHeight = node && node.scrollHeight;\n        if (currHeight && maxHeight.value !== currHeight) {\n          setMaxHeight(currHeight);\n        }\n      });\n    };\n\n    const resetHeight = () => {\n      ref_.value.style.maxHeight = 'none';\n    };\n\n    const formatStyle = (style: TransitionStyle) => {\n      // eslint-disable-next-line @typescript-eslint/no-shadow\n      const { maxHeight } = style;\n      return { maxHeight };\n    };\n\n    const renderChildren = (transitionStyle: TransitionStyle) => {\n      const transition = transitionStyle && typeof transitionStyle === 'object' ? formatStyle(transitionStyle) : {};\n\n      const style: CSSProperties = {\n        overflow: 'hidden',\n        maxHeight: open.value ? 'none' : 0,\n        ...transition,\n      };\n      const children = slots.default?.();\n      return (\n        <div style={style} class={`${cssClasses.PREFIX}-wrapper`} ref={ref_}>\n          <div ref={setHeight}>{children}</div>\n        </div>\n      );\n    };\n    const didLeave = () => {\n      setLeft(true);\n      setMaxHeight(0);\n      props.motionType === 'leave' && props.onMotionEnd();\n    };\n\n    const onImmediateEnter = () => {\n      open.value && setOpen(false);\n      setImmediateAttr(false);\n    };\n\n    const didEnter = () => {\n      resetHeight();\n      immediateAttr.value && onImmediateEnter();\n      props.motionType === 'enter' && props.onMotionEnd();\n    };\n\n    return () => {\n      if (left.value) {\n        return null;\n      }\n\n      const mergeMotion = getMotionObjFromProps({\n        didEnter,\n        didLeave,\n        motion: props.motion,\n      });\n\n      return props.motion ? (\n        <Transition\n          state={open.value ? 'enter' : 'leave'}\n          immediate={immediateAttr.value}\n          from={{ maxHeight: 0 }}\n          enter={{ maxHeight: { val: maxHeight.value, easing: ease, duration: props.duration } }}\n          leave={{ maxHeight: { val: 0, easing: ease, duration: props.duration } }}\n          {...mergeMotion}\n        >\n          {(transitionStyle: TransitionStyle) => renderChildren(transitionStyle)}\n        </Transition>\n      ) : (\n        renderChildren(null)\n      );\n    };\n  },\n});\n\nexport default Collapse;\n"],"names":["ease","propsType","motion","PropTypes","oneOfType","bool","func","object","duration","number","onMotionEnd","motionType","String","vuePropsType","vuePropsMake","noop","Collapse","defineComponent","props","name","setup","slots","useSlots","ref_","ref","maxHeight","setMaxHeight","val","value","open","setOpen","left","setLeft","immediateAttr","setImmediateAttr","watch","useEffect","setHeight","node","nextTick","currHeight","scrollHeight","resetHeight","style","formatStyle","renderChildren","transitionStyle","transition","overflow","children","default","_createVNode","cssClasses","PREFIX","didLeave","onImmediateEnter","didEnter","mergeMotion","getMotionObjFromProps","Transition","_mergeProps","easing"],"mappings":"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"}